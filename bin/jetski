#!/usr/bin/env ruby

require 'optparse'
require 'jetski'
require 'thor'
require_relative './jetski_cli_helpers/generate.rb'
require_relative './jetski_cli_helpers/destroy.rb'
require 'bundler/setup'

class JetskiCLI < Thor
  include Thor::Actions
  desc "new APP_NAME", "Create a new Jetski app"
  def new(name)
    return say "There is already a folder named #{name} in this directory." if File.exist?(name)
    FileUtils.mkdir_p(name)
    say "Creating #{name} app with Jetski!"
    directory "base", "#{name}"
    gsub_file "#{name}/app/views/layouts/application.html.erb", /APP_NAME/, name.capitalize
    gsub_file "#{name}/app/views/pages/home.html.erb", /APP_NAME/, name.capitalize
    run "cd #{name} && bundle install"
    say "ğŸŒŠ Your app #{name} has been generated!"
  end

  desc "-v, --version", "show Jetski version"
  def version
    say "Jetski v#{Jetski::VERSION}"
  end

  desc "routes", "shows the routes in your app."
  def routes
    compiled_routes = Jetski::Router::Parser.compile_routes
    say "ğŸŒŠ Jetski Routes ğŸ„â€â™‚ï¸"
    compiled_routes.each do |route_obj|
      say "#{route_obj[:method]} #{route_obj[:url]} #{route_obj[:controller_name]}##{route_obj[:action_name]}"
    end
  end

  desc "server", "starts the jetski app"
  def server
    ENV['JETSKI_PROJECT_PATH'] = __dir__
    Jetski::Server.new.call
  end

  desc "generate", "generates resources in your jetski app"
  subcommand "generate", JetskiCLIHelpers::Generate

  desc "destroy", "destroys a resource in your jetski app"
  subcommand "destroy", JetskiCLIHelpers::Destroy
  
  def self.source_root
    File.join(File.dirname(__FILE__), 'templates')
  end
end

# Version command seperate from thor for simplicity
if ["-v", "--version"].include?(ARGV[0])
  puts "Jetski v#{Jetski::VERSION}"
else
  JetskiCLI.start(ARGV)
end