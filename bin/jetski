#!/usr/bin/env ruby

require 'jetski'
require 'optparse'
require 'thor'
require "pry"

require_relative './jetski_cli_helpers/generators/controller.rb'
require_relative './jetski_cli_helpers/generators/model.rb'
require_relative './jetski_cli_helpers/destroyers/controller.rb'
require_relative './jetski_cli_helpers/destroyers/model.rb'
require_relative './jetski_cli_helpers/shared_methods.rb'
require_relative './jetski_cli_helpers/generate.rb'
require_relative './jetski_cli_helpers/destroy.rb'
require_relative './jetski_cli_helpers/database.rb'

require 'bundler/setup'

class JetskiCLI < Thor
  include Thor::Actions
  desc "new APP_NAME", "Create a new Jetski app"
  def new(name)
    return say "There is already a folder named #{name} in this directory." if File.exist?(name)
    FileUtils.mkdir_p(name)
    say "Creating #{name} app with Jetski!"
    directory "base", "#{name}"
    gsub_file "#{name}/app/views/layouts/application.html.erb", /APP_NAME/, name.capitalize
    gsub_file "#{name}/app/views/pages/home.html.erb", /APP_NAME/, name.capitalize
    run "cd #{name} && bundle install"
    say "ðŸŒŠ Your app #{name} has been generated!"
  end

  desc "-v, --version", "show Jetski version"
  def version
    say "Jetski v#{Jetski::VERSION}"
  end

  desc "routes", "shows the routes in your app."
  def routes
    compiled_routes = Jetski::Router::Parser.compile_routes
    say "ðŸŒŠ Jetski Routes ðŸ„â€â™‚ï¸"
    compiled_routes.each do |route_obj|
      say "#{route_obj[:method]} #{route_obj[:url]} #{route_obj[:controller_name]}##{route_obj[:action_name]}"
    end
  end

  desc "server", "starts the jetski app"
  method_option :port, :aliases => "-p", :desc => "Configure which port number to run server on"
  def server
    Jetski::Server.new(port: options[:port]).call
  end

  desc "console", "opens jetski console"
  def console
    Jetski::Autoloader.call
    Jetski::Autoloader.load_controllers
    Pry.start
  end

  desc "generate", "generates resources in your jetski app"
  subcommand "generate", JetskiCLIHelpers::Generate

  desc "destroy", "destroys a resource in your jetski app"
  subcommand "destroy", JetskiCLIHelpers::Destroy

  desc "db", "commands related to database"
  subcommand "db", JetskiCLIHelpers::Database
  
  def self.source_root
    File.join(File.dirname(__FILE__), '..', 'templates')
  end
end

# Version command seperate from thor for simplicity
if ["-v", "--version"].include?(ARGV[0])
  puts "Jetski v#{Jetski::VERSION}"
else
  JetskiCLI.start(ARGV)
end